digraph Issue {
  // Generic pipeline for GitHub issues.
  // Stages communicate via .factory/ artifacts â€” each stage reads the previous stage's output.
  // Stage prompts are in prompts/*.md files.
  //
  // Usage:
  //   ISSUE_NUMBER=57 REPO_PATH=/path/to/repo bun run run.ts issue.dot
  //   Or via wrapper: ./run-issue.sh 57 /path/to/repo
  //
  // Required env vars: ISSUE_NUMBER, ISSUE_URL, REPO_PATH, REPO_SLUG
  // Optional env vars: PROJECT_ID, STATUS_FIELD_ID, STATUS_IN_PROGRESS_ID, STATUS_REVIEW_ID

  graph [goal="$ISSUE_URL", default_max_retry="2"]

  start [shape=Mdiamond]
  exit  [shape=Msquare]

  setup    [label="Setup",     prompt_file="prompts/setup.md"]
  plan     [label="Plan",      model="opus46", prompt_file="prompts/plan.md"]
  implement [label="Implement", prompt_file="prompts/implement.md"]
  test     [label="Test",      model="quick",  prompt_file="prompts/test.md"]
  review   [label="Review",    model="opus46", prompt_file="prompts/review.md"]
  publish  [label="Publish",   prompt_file="prompts/publish.md"]

  // Pipeline flow
  start -> setup -> plan -> implement -> test -> review -> publish -> exit

  // Retry: if test fails, feed back to implement with feedback.md
  test -> implement [label="tests fail", condition="outcome=fail"]
}
